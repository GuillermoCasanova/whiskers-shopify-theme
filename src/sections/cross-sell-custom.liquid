{% comment %}
============= Warning: DO NOT EDIT THIS FILE! =============

Editing this file could break Cross Sell app functionality. 
This file might be overwritten.
version: xsell-v2.1.2 [Do not remove version info]
Support website: http://help.csell.co

============= Warning: DO NOT EDIT THIS FILE! =============
{% endcomment %}

{% if template contains 'product' %}
  {% assign cscurrentpage = 'product' %}
{% endif %}
{% if template == 'cart' %}
  {% assign cscurrentpage = 'cart' %}
  {% assign cssmartcart = 'on' %}
{% endif %}

{% assign cartitems = ''%}
{% for item in cart.items %}
  {% if forloop.first == true %}
    {% capture cartitems %}{{ item.product.handle }}{% endcapture %}
  {% else %}
    {% capture cartitems %}{{ cartitems }},{{ item.product.handle }}{% endcapture %}
  {% endif %}
{% endfor %}

{% if shop.metafields.shopCrosssell.settings != null %}
<style>
  .xs-clearfix:after {
    content: ".";
    visibility: hidden;
    display: block;
    height: 0;
    clear: both;
  }
</style>


<section class="section--lead">
  <div data-ui-component="hello">
      <script id="xsTemplate" type="text/template">
      {% raw %}
        <div class="row small-collapse">
          <div class="small-12  medium-centered  columns">
              <div class="grid  grid--justifyCenter">
                <div class="collectionContainer">
                  
                  <div class="categoryHeader"> 
                    <h2 class="categoryHeader-title">You might also like these</h2>
                  </div>
                    
                  <div class="row">
                    <div class="small-12 columns">
                      <ul class="grid  
                                 grid--flexDirectionRow
                                 grid--1of2
                                 grid--flexWrap
                                 med-grid--flexDirectionRow
                                 med-grid--1of4
                                 productThumbs">
                  
                        {{#each this}}
                        <li class="grid-cell">
                          <a class="productThumb  {% unless product.available %}productThumb--soldOut{% endunless %}" href="{{url}}" data-product>
  
                               <div class="productThumb-addToCart">
                                  <form action="/cart/add" method="post" id="AddToCartForm"  enctype="multipart/form-data" data-thumb-add-to-cart-form>   
                                  <input type="hidden" name="id" value="{{ variants.[0].id }}">
                                    <button type="submit" name="add" id="AddToCart" data-thumb-add-to-cart-btn>
                                    {% endraw %} {%include 'icon-cart' %} {% raw %}
                                    </button>
                                </form>
                              </div>
  
                            <div class="productThumb-inner">
                              <div class="productThumb-bg">
                               <img src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" data-src="{{ images.main.src}}" alt="{{title}}" data-sizes="auto" data-product-img  class="lazyload">
                                {{#if  images.secondary}}
                                <div class="productThumb-bg-secondaryImg">
                                  <img src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" data-src="{{ images.secondary.src}}" alt="{{title}}" data-sizes="auto"  class="lazyload" data-product-img>
                                </div>
                                {{/if}}
                              </div>
                              <div class="productThumb-description text-center grid grid--center grid--justifySpaceBetween">
  
                                <h3 class="productThumb-title">{{title}}</h3>
                            
                              </div>
                            </div>
                                 
                          </a>
                        </li>
                        {{/each}}
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
          </div>
        </div>
      {%endraw %}
      </script>
  </div>
</section>



<div class="xs-clearfix"></div>
<div id="cross-sell"></div>
<div class="xs-clearfix"></div>


<script type="text/javascript" charset="utf-8">

  var xsellSettings = xsellSettings || {};
  {% if cartitems %}
  var cartitems = '{{ cartitems }}';
  xsellSettings.cartitems = cartitems.split(',');
  {% else %}
  xsellSettings.cartitems = [];
  {% endif %}

  xsellSettings.shopMetafields = eval({{ shop.metafields.shopCrosssell | json }});
  xsellSettings.crosssellsettings = eval({{ shop.metafields.shopCrosssell.settings | json }});
  xsellSettings.money_format = '{{shop.money_format}}';
  xsellSettings.xsmainproducthandle = '{{ product.handle }}';
  xsellSettings.currentpagetype = '{{ cscurrentpage }}';
  xsellSettings.xsimagesize = 'large';

  xsellSettings.xsrandomizeproductpage = xsellSettings.crosssellsettings[0]['randomizeproductpage'];
  xsellSettings.xsrandomizecartpage = xsellSettings.crosssellsettings[0]['randomizecartpage'];
  xsellSettings.xsmustbeavailable = xsellSettings.crosssellsettings[0]['mustbeavailable'];
  xsellSettings.xshideifincart = xsellSettings.crosssellsettings[0]['hideifincart'];

  xsellSettings.xsdisplaycompareatprice = xsellSettings.crosssellsettings[0]['displaycompareatprice'];
  xsellSettings.xsdisplaysalebadge = xsellSettings.crosssellsettings[0]['displaysalebadge'];
  xsellSettings.xsdisplaypricevarieslabel = xsellSettings.crosssellsettings[0]['displaypricevarieslabel'];
  xsellSettings.xsdisplayvendor = xsellSettings.crosssellsettings[0]['displayvendor'];


  {% if cscurrentpage == 'product' %}
  //product specific settings
  var crossselltitleproductpage = xsellSettings.crosssellsettings[0]['titleproductpage'];
  var crossselltitleproductpagedefault = xsellSettings.crosssellsettings[0]['titleproductpagedefault'];
  var crosssellshowdefault = xsellSettings.crosssellsettings[0]['showdefault'];

  xsellSettings.crosssellmaxitems = xsellSettings.crosssellsettings[0]['productpagemaxitems'];
  {% else if cscurrentpage == 'cart' %}
    //cart/basket settings
  var crossselltitlecheckoutpage = xsellSettings.crosssellsettings[0]['titlecheckoutpage'];
  var crosssellshowcheckout = xsellSettings.crosssellsettings[0]['showcheckout'];

  xsellSettings.crosssellmaxitems = xsellSettings.crosssellsettings[0]['checkoutpagemaxitems'];
  {% endif %}

</script>

{% endif %}

<script type="text/javascript" charset="utf-8">

var xsproductsData = '';
xsellSettings.xstitle = "";
  {% if cscurrentpage == 'product' %}

  if(crosssellshowdefault != '4'){
    {% if product.metafields.productDetails.crosssell != null %}
    xsellSettings.product_crosssells = eval({{ product.metafields.productDetails.crosssell | json }});
    xsproductsData = xsellSettings.product_crosssells;
    if(crossselltitleproductpage.length){
      xsellSettings.xstitle = crossselltitleproductpage;
    }
    {% endif %}
  }
  if(crosssellshowdefault == '1' || (crosssellshowdefault == '2' && xsproductsData == '')){
    {% if shop.metafields.shopCrosssell.default != null %}
    xsellSettings.default_crosssells = eval({{ shop.metafields.shopCrosssell.default | json }});
    xsproductsData = xsellSettings.default_crosssells;
    if(crossselltitleproductpagedefault.length){
      xsellSettings.xstitle = crossselltitleproductpagedefault;
    }
    {% endif %}
  }
{% else %}
  if(crosssellshowcheckout == '2'){
    {% if shop.metafields.shopCrosssell.settings != null %}
      {% assign crosssellsettings = shop.metafields.shopCrosssell.settings | remove: "[{" | remove: "}]" | strip | replace: '","', '"|||"' | replace: '", "', '"|||"' | split: '|||' %}
      {% for settingpair in crosssellsettings %}
      {% assign setting = settingpair | strip | split: ' : ' %}
        {% capture main %}{{ setting[0] | replace: '"', '' }}{% endcapture %}
        {% case main %}               
          {% when 'cssmartcart' %}
          {% capture cssmartcart %}{{ setting[1] | replace: '"', '' }}{% endcapture %}
        {% endcase %}
      {% endfor %}
    {% endif %}

    {% if cssmartcart == 'on' %}
      {% for item in cart.items %}
        {% assign csitem = all_products[item.product.handle] %}
    {% if csitem.metafields.productDetails.crosssell != null %}
      {% assign csitemmetafield = csitem.metafields.productDetails.crosssell %}
          {% capture cssmartcartxsells %}{{ csitemmetafield }}{% endcapture %}
          {% break %}
        {% endif %}
      {% endfor %}
    {% endif %}
    
    {% if shop.metafields.shopCrosssell.checkout != null %}
      {% assign csdefaultcartxsells = shop.metafields.shopCrosssell.checkout %}
    {% endif %}

    {% if cssmartcart == 'on' and cssmartcartxsells != null %}
      {% assign _xsproductsData = cssmartcartxsells %}
    {% else %}
      {% assign _xsproductsData = csdefaultcartxsells %}
    {% endif %}
    
    xsproductsData = eval({{ _xsproductsData | json }});

    if(crossselltitlecheckoutpage.length){
      xsellSettings.xstitle = crossselltitlecheckoutpage;
    }
  }
{% endif %}

// if(xsproductsData){
//   if (xsproductsData.length && (xsproductsData[0] !== '')){
//     window.xsellData = {
//       data: xsproductsData,
//       settings: xsellSettings
//     }
//   } else {

//     window.xsellData = {
//       data: xsproductsData,
//       settings: xsellSettings
//     }
//     // var elem = document.getElementById("cross-sell");
//     // if (elem){
//     //   elem.parentNode.removeChild(elem);
//     // }
//   }
// }


</script>

{% javascript %}
//<script>
  
    var xsproducts = []; 


    function getProductData(handle) {
       return jQuery.getJSON('/products/' +  handle + '.js');
    }


    function generateTemplate(products) {
      var products = products,
        source = $('#xsTemplate').html(),
        template = Handlebars.compile(source); 

        var items  = []; 
        var data = {}; 
        var selectors = {
          products: '[data-product]'
        };

        console.log(products); 

  
        for(var i = 0; i < products.length; i++) {
          /* Hack to get product image thumbnail
           *   - If image is not null
           *     - Remove file extension, add _large, and re-add extension
           *     - Create server relative link
           *   - A hard-coded url of no-image
          */
         var mainImg,
             secondaryImg; 

          if(products[i].images !==null) {
            mainImg = products[i].images[0]
                    .replace(/(\.[^.]*)$/, '_large$1')
                    .replace('http:', '');

            secondaryImg = products[i].images[2]
                    .replace(/(\.[^.]*)$/, '_1100x1100$1')
                    .replace('http:', '');
          } else {
            mainImg = '//cdn.shopify.com/s/assets/admin/no-image-medium-cc9732cb976dd349a0df1d39816fbcc7.gif';
            secondaryImg = '//cdn.shopify.com/s/assets/admin/no-image-medium-cc9732cb976dd349a0df1d39816fbcc7.gif'; 
          } 


          var item = {
            // key: cartItem.key,
            // line: index + 1, // Shopify uses a 1+ index in the API
            images: {
              main: {
                src: mainImg
              },
              secondary: {
                src: secondaryImg
              }
            },
            title: products[i].title,
            url: products[i].url,
            variants: products[i].variants
            // price: slate.Currency.formatMoney(cartItem.price, settings.moneyFormat),
            // discountedPrice: slate.Currency.formatMoney(
            //   cartItem.price - cartItem.total_discount / cartItem.quantity,
            //   settings.moneyFormat
            // ),
            // name: cartItem.product_title,
            // variation: cartItem.variant_title,
            // properties: cartItem.properties,
            // itemAdd: cartItem.quantity + 1,
            // itemMinus: cartItem.quantity - 1,
            // itemQty: cartItem.quantity,
            // price: slate.Currency.formatMoney(cartItem.price, settings.moneyFormat),
            // discountedPrice: slate.Currency.formatMoney(
            //   cartItem.price - cartItem.total_discount / cartItem.quantity,
            //   settings.moneyFormat
            // ),
            // discounts: cartItem.discounts,
            // discountsApplied:
            //   cartItem.price === cartItem.price - cartItem.total_discount
            //     ? false
            //     : true,
            // vendor: cartItem.vendor
          };

         if(i == 4) {
            break;
            console.log('hit 5'); 
          }

          items.push(item); 
        }

        console.log(items); 

        data.items = items; 

      $('[data-ui-component="hello"]').append(template(data.items))

      setTimeout(function() {

       //
        // Defines the entry animations for our products
        //
        $(selectors.products).each(function(index, element) {
          
          var product = element;

          TweenMax.set($(product).find('[data-product-img]'), {autoAlpha: 1});

          var delay = ((index + 1) === 4) ?  1 : (index + 1);

          var productEntry = new TimelineLite()
                  .from($(product).find('[data-product-img]'), .3, {opacity: 0}, .02 * delay);

          var productScene = new ScrollMagic.Scene({
              triggerElement: product,
              triggerHook: 'onEnter',
              reverse: false
            })
            .setTween(productEntry)
            .addTo(self.animCtrl); 

        });

        //
        // Initializes the AJAX cart properties for product thumbnails in cross-sell
         ajaxCart.init({
            formSelector: '[data-thumb-add-to-cart-form]',
            cartContainer: '#CartContainer',
            addToCartSelector: '[data-thumb-add-to-cart-btn]',
            enableQtySelectors: true,
            moneyFormat: theme.strings.moneyFormat
        });
      }, 300); 
      
    }

    if(xsproductsData) {
      for(var i = 0; i < xsproductsData.length; i++) {
        xsproducts.push(getProductData(xsproductsData[i].handle));
      }
    }

    $.when.apply($, xsproducts).done(function(response){
      var obj = [];
      for(var i = 0, len = arguments.length; i < len; i++){
          obj.push(arguments[i][0]);
      }
      generateTemplate(obj);
    }); 


//</script>
{% endjavascript %}
